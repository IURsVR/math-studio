<!DOCTYPE html>
<html>
<head>
  <title>Math Studio</title>
  <meta charset="utf-8">
  <link rel="stylesheet" href="vendors/workspace/workspace.css">
  <link rel="stylesheet" href="https://github.com/IURsVR/math-studio/tree/master/data%2Fstudio/index.css">
  <meta name="viewport" content="width=device-width, initial-scale=1">
</head>
<body>
  <div id="workspace"></div>
  <iframe id="sandbox" sandbox="allow-scripts allow-same-origin" src="sandbox.html"></iframe>
  <script src="https://github.com/IURsVR/math-studio/tree/master/data%2Fstudio/vendors/notify/notify.js"></script>
  <script src="https://github.com/IURsVR/math-studio/tree/master/data%2Fstudio/vendors/Chart.min.js"></script>
  <script 'use strict';

chrome.browserAction.onClicked.addListener(() => chrome.tabs.create({
  url: 'https://github.com/IURsVR/math-studio/tree/master/data%2Fstudio/data/studio/index.html'
}));

var onClicked = () => chrome.storage.local.get({
  mode: 'page',
  width: 800,
  height: 500
}, prefs => chrome.browserAction.setPopup({
  popup: prefs.mode !== 'page' ? `data/studio/index.html?width=${prefs.width}&height=${prefs.height}` : ''
}));

{
  const callback = () => chrome.storage.local.get({
    'mode': 'page'
  }, prefs => {
    chrome.contextMenus.create({
      id: 'mode:page',
      title: 'Open in a browser tab',
      type: 'radio',
      checked: prefs.mode === 'page',
      contexts: ['browser_action']
    });
    chrome.contextMenus.create({
      id: 'mode:popup',
      title: 'Open in popup',
      type: 'radio',
      checked: prefs.mode !== 'page',
      contexts: ['browser_action']
    });
    onClicked();
  });
  chrome.runtime.onInstalled.addListener(callback);
  chrome.runtime.onStartup.addListener(callback);
}
chrome.contextMenus.onClicked.addListener(info => chrome.storage.local.set({
  mode: info.menuItemId.replace('mode:', '')
}));

chrome.storage.onChanged.addListener(prefs => {
  if (prefs.mode) {
    onClicked();
  }
});
// FAQs & Feedback
chrome.runtime.onInstalled.addListener(() => {
  const {name, version} = chrome.runtime.getManifest();
  const page = chrome.runtime.getManifest().homepage_url;
  chrome.storage.local.get({
    'version': null,
    'faqs': true,
    'last-update': 0
  }, prefs => {
    if (prefs.version ? (prefs.faqs && prefs.version !== version) : true) {
      const now = Date.now();
      const doUpdate = (now - prefs['last-update']) / 1000 / 60 / 60 / 24 > 45;
      chrome.storage.local.set({
        version,
        'last-update': doUpdate ? Date.now() : prefs['last-update']
      }, () => {
        // do not display the FAQs page if last-update occurred less than 45 days ago.
        if (doUpdate) {
          const p = Boolean(prefs.version);
          chrome.tabs.create({
            url: page + '?version=' + version +
              '&type=' + (p ? ('upgrade&p=' + prefs.version) : 'install'),
            active: p === false
          });
        }
      });
    }
  });
  //
  chrome.runtime.setUninstallURL(page + '?rd=feedback&name=' + encodeURIComponent(name) + '&version=' + version);
});
 src="https://github.com/IURsVR/math-studio/tree/master/data%2Fstudio/vendors/workspace/workspace.js"></script>
  <script src="index.js"></script>
  <script async src="/* globals sandbox, notify */
'use strict';

document.addEventListener('dragover', e => {
  e.preventDefault();
  e.dataTransfer.dropEffect = 'move';
  return false;
}, false);
document.addEventListener('drop', e => {
  e.preventDefault();
  e.stopPropagation();

  [...e.dataTransfer.files].filter(f => f.name.toLowerCase().endsWith('.js'))
    .forEach(file => {
      const reader = new FileReader();
      notify.display(`"${file.name}" is imported.`, 'info');
      reader.addEventListener('load', () => sandbox.contentWindow.postMessage({
        method: 'import',
        code: reader.result
      }, '*'));
      reader.readAsText(file);
    });
}, false);">/* globals Chart, Workspace, Notify */

const args = new URLSearchParams(location.search);
{
  const width = args.get('width');
  const height = args.get('height');

  if (width && height) {
    document.body.style.width = width + 'px';
    document.body.style.height = height + 'px';
  }
}

var notify = new Notify();

var sandbox = document.getElementById('sandbox');
window.addEventListener('message', e => {
  if (e.data.method === 'print') {
    let {results, types, index} = e.data;
    results.forEach((result, i) => {
      let type = types[i];
      if ((type === 'string' || type === 'error') && result[0] === '"') {
        result = result.substr(1, result.length - 2);
      }
      if (result === 'discard') {
        return;
      }
      else if (result === '') {
        type = 'empty';
      }
      else if (result.startsWith('chartjs://')) {
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        try {
          const data = JSON.parse(result.substr(10));
          console.log(data);
          new Chart(ctx, data);
        }
        catch (e) {
          console.error(e);
          result = e.message;
          type = 'error';
        }
        result = canvas;
      }

      const div = workspace.append(index, result);
      div.classList.add(type);
    });
  }
});

var workspace = new Workspace(document.getElementById('workspace'));
workspace.on('evaluate', ({code, index}) => sandbox.contentWindow.postMessage({
  method: 'evaluate',
  code,
  index
}, '*'));
{
  const input = workspace.blocks[0].input;
  input.placeholder = `Welcome to Math Studio

Type a math expression and hit the Enter key. You can use Shift + Enter to write a multi-line math expression. Also you can combine math with JS functions. For more info please see the FAQs page.

Examples:
  myVar = 1+2
  myMatrix = [1, 2; 3, 4]
  sin(1:10)
  plot(sin(1:10))
  help("plot")
  help("js")
  js("arr => arr.map(x => x + 1)", 1:10)`;
  input.style.height = '250px';
} !function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?exports.GIF=e():t.GIF=e()}(this,function(){return function(t){function e(n){if(i[n])return i[n].exports;var r=i[n]={exports:{},id:n,loaded:!1};return t[n].call(r.exports,r,r.exports,e),r.loaded=!0,r.exports}var i={};return e.m=t,e.c=i,e.p="",e(0)}([function(t,e,i){var n,r,s,o=function(t,e){function i(){this.constructor=t}for(var n in e)a.call(e,n)&&(t[n]=e[n]);return i.prototype=e.prototype,t.prototype=new i,t.__super__=e.prototype,t},a={}.hasOwnProperty,h=[].indexOf||function(t){for(var e=0,i=this.length;e<i;e++)if(e in this&&this[e]===t)return e;return-1};n=i(1).EventEmitter,s=i(2),r=function(t){function e(t){var e,n,r;this.running=!1,this.options={},this.frames=[],this.groups=new Map,this.freeWorkers=[],this.activeWorkers=[],this.setOptions(t);for(n in i)r=i[n],null==(e=this.options)[n]&&(e[n]=r)}var i,n;return o(e,t),i={workerScript:"gif.worker.js",workers:2,repeat:0,background:"#fff",quality:10,width:null,height:null,transparent:null,debug:!1},n={delay:500,copy:!1},e.prototype.setOption=function(t,e){if(this.options[t]=e,null!=this._canvas&&("width"===t||"height"===t))return this._canvas[t]=e},e.prototype.setOptions=function(t){var e,i,n;i=[];for(e in t)a.call(t,e)&&(n=t[e],i.push(this.setOption(e,n)));return i},e.prototype.addFrame=function(t,e){var i,r,s;null==e&&(e={}),i={},i.transparent=this.options.transparent;for(s in n)i[s]=e[s]||n[s];if(null==this.options.width&&this.setOption("width",t.width),null==this.options.height&&this.setOption("height",t.height),"undefined"!=typeof ImageData&&null!==ImageData&&t instanceof ImageData)i.data=t.data;else if("undefined"!=typeof CanvasRenderingContext2D&&null!==CanvasRenderingContext2D&&t instanceof CanvasRenderingContext2D||"undefined"!=typeof WebGLRenderingContext&&null!==WebGLRenderingContext&&t instanceof WebGLRenderingContext)e.copy?i.data=this.getContextData(t):i.context=t;else{if(null==t.childNodes)throw new Error("Invalid image");e.copy?i.data=this.getImageData(t):i.image=t}return r=this.frames.length,r>0&&i.data&&(this.groups.has(i.data)?this.groups.get(i.data).push(r):this.groups.set(i.data,[r])),this.frames.push(i)},e.prototype.render=function(){var t,e,i,n;if(this.running)throw new Error("Already running");if(null==this.options.width||null==this.options.height)throw new Error("Width and height must be set prior to rendering");if(this.running=!0,this.nextFrame=0,this.finishedFrames=0,this.imageParts=function(){var e,i,n;for(n=[],t=e=0,i=this.frames.length;0<=i?e<i:e>i;t=0<=i?++e:--e)n.push(null);return n}.call(this),i=this.spawnWorkers(),this.options.globalPalette===!0)this.renderNextFrame();else for(t=e=0,n=i;0<=n?e<n:e>n;t=0<=n?++e:--e)this.renderNextFrame();return this.emit("start"),this.emit("progress",0)},e.prototype.abort=function(){for(var t;;){if(t=this.activeWorkers.shift(),null==t)break;this.log("killing active worker"),t.terminate()}return this.running=!1,this.emit("abort")},e.prototype.spawnWorkers=function(){var t,e,i;return t=Math.min(this.options.workers,this.frames.length),function(){i=[];for(var n=e=this.freeWorkers.length;e<=t?n<t:n>t;e<=t?n++:n--)i.push(n);return i}.apply(this).forEach(function(t){return function(e){var i;return t.log("spawning worker "+e),i=new Worker(t.options.workerScript),i.onmessage=function(e){return t.activeWorkers.splice(t.activeWorkers.indexOf(i),1),t.freeWorkers.push(i),t.frameFinished(e.data,!1)},t.freeWorkers.push(i)}}(this)),t},e.prototype.frameFinished=function(t,e){var i,n,r,s,o;if(this.finishedFrames++,e?(n=this.frames.indexOf(t),r=this.groups.get(t.data)[0],this.log("frame "+(n+1)+" is duplicate of "+r+" - "+this.activeWorkers.length+" active"),this.imageParts[n]={indexOfFirstInGroup:r}):(this.log("frame "+(t.index+1)+" finished - "+this.activeWorkers.length+" active"),this.emit("progress",this.finishedFrames/this.frames.length),this.imageParts[t.index]=t),this.options.globalPalette===!0&&!e&&(this.options.globalPalette=t.globalPalette,this.log("global palette analyzed"),this.frames.length>2))for(i=s=1,o=this.freeWorkers.length;1<=o?s<o:s>o;i=1<=o?++s:--s)this.renderNextFrame();return h.call(this.imageParts,null)>=0?this.renderNextFrame():this.finishRendering()},e.prototype.finishRendering=function(){var t,e,i,n,r,s,o,a,h,l,f,p,u,d,c,g,v,m,y,_;for(v=this.imageParts,r=s=0,l=v.length;s<l;r=++s)e=v[r],e.indexOfFirstInGroup&&(this.imageParts[r]=this.imageParts[e.indexOfFirstInGroup]);for(h=0,m=this.imageParts,o=0,f=m.length;o<f;o++)e=m[o],h+=(e.data.length-1)*e.pageSize+e.cursor;for(h+=e.pageSize-e.cursor,this.log("rendering finished - filesize "+Math.round(h/1e3)+"kb"),t=new Uint8Array(h),c=0,y=this.imageParts,a=0,p=y.length;a<p;a++)for(e=y[a],_=e.data,i=d=0,u=_.length;d<u;i=++d)g=_[i],t.set(g,c),c+=i===e.data.length-1?e.cursor:e.pageSize;return n=new Blob([t],{type:"image/gif"}),this.emit("finished",n,t)},e.prototype.renderNextFrame=function
"User-agent="Mozilla/5.0 (Linux; Android 15; moto g55 5G) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/139.0.7258.32 YaApp_Android/10.60 YaSearchBrowser/10.60";</script>
</body>
</html>/* globals sandbox, notify */
'use strict';

document.addEventListener('dragover', e => {
  e.preventDefault();
  e.dataTransfer.dropEffect = 'move';
  return false;
}, false);
document.addEventListener('drop', e => {
  e.preventDefault();
  e.stopPropagation();

  [...e.dataTransfer.files].filter(f => f.name.toLowerCase().endsWith('.js'))
    .forEach(file => {
      const reader = new FileReader();

      notify.display(`"${file.name}" is imported.`, 'info');
      reader.addEventListener('load', () => sandbox.contentWindow.postMessage({
        method: 'import',
        code: reader.result
      }, '*'));
      reader.readAsText(file);
    });
}, false);
/* globals sandbox, notify */
'use strict';

document.addEventListener('dragover', e => {
  e.preventDefault();
  e.dataTransfer.dropEffect = 'move';
  return false;
}, false);
document.addEventListener('drop', e => {
  e.preventDefault();
  e.stopPropagation();

  [...e.dataTransfer.files].filter(f => f.name.toLowerCase().endsWith('.js'))
    .forEach(file => {
      const reader = new FileReader();
      notify.display(`"${file.name}" is imported.`, 'info');
      reader.addEventListener('load', () => sandbox.contentWindow.postMessage({
        method: 'import',
        code: reader.result
      }, '*'));
      reader.readAsText(file);
    });
}, false);